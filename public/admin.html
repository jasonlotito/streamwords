<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>StreamWords Admin</title>
  <style>
      * {
          font-family: sans-serif;
          font-size: 16px;
      }

      input, select, button {
          padding: 5px 10px;
          font-size: 16px;
      }

      button {
          cursor: pointer;
      }

      label {
          display: inline-block;
          /*width: 200px;*/
      }

      fieldset {
          margin-top: 10px;
          display: flex;
          flex-direction: column;
          row-gap: 20px;
          border-radius: 10px;
          border-width: 10px;
          border-bottom-style: ridge;
          border-right-style: ridge;
          border-top-style: groove;
          border-left-style: groove;
      }

      fieldset.buttons {
          flex-direction: row;
          gap: 10px;
      }

      h1 {
          font-size: 2.2em;
          font-weight: bold;
          /*color: #fff;*/
          text-align: center;
      }

      legend {
          font-size: 2em;
          font-weight: bold;
      }

      #debugArea {
          display: none;
      }

      .deleteHistory {
          background-color: transparent;
          border: 0;
      }

      body {
          /*background-color: #333;*/
      }

      .main {
          /*background-color: #fff;*/
          /*padding: 20px;*/
          /*border-radius: 50px 50px 0 0;*/
      }

      body {
          display: grid;
          grid-gap: 1em;
          grid: 'header' auto
                'main' 1fr
                'footer' auto
              / 1fr;
      }

      @media (min-width: 40em) {
          .main {
              display: grid;
              grid-gap: 1em;
              grid: 'manage leaders words'
              / 2fr 1fr 1fr;
          }
      }

      header {
          grid-area: header;
      }

      .main {
          grid-area: main;
      }

      section.manage {
          grid-area: manage;
      }

      section.info {
          grid-area: info;
      }

      footer {
          grid-area: footer;
      }
  </style>
</head>
<body>
<header>
  <h1>StreamWords Manager</h1>
</header>
<div class="main">
  <section id="debugArea">
    <h1>Admin</h1>
    <form id="form" onsubmit="return false;">
      <fieldset>
        <legend>All messages</legend>
        <span>
    <label for="messageType">
      Message Type:
    </label>
      <select id="messageType">
        <option value="join">join</option>
        <option value="setWord">setWord</option>
      </select>
    </span>
        <span>
        <label for="messageValue">
        Message Value:
        </label>
        <input type="text" name="name" placeholder="younow name" id="messageValue" value="jasonml">

    </span>
        <span>
      <button id="btnSendMessage">Send Message</button>
    </span>
      </fieldset>

    </form>
  </section>
  <section class="manage">
    <form action="setWord" class="formMessage">
      <fieldset>
        <legend>Set Word</legend>
        <span>
      <label for="setWord-setWord">Set Word</label>
      <input type="text" name="message" id="setWord-setWord">
      <p>Recommended to keep the number of letters fewer than 8.</p>
    </span>
        <span>
      <button type="submit">Set Word</button>
    </span>
      </fieldset>
    </form>

    <form action="manage" class="formMessage">
      <fieldset class="buttons">
        <legend>Manage</legend>
        <button type="submit" name="message" value="clear">Clear Board</button>
      </fieldset>
    </form>
    <a href="" id="__refresh"></a>

    <!--  <h2>History</h2>-->
    <!--  <ul id="wordHistory"></ul>-->
  </section>

  <section class="leaders">
    <h2>Leaders</h2>
    <ul id="winnerList">

    </ul>
  </section>
  <section class="words">
    <h2>Words</h2>
    <ul id="wordList">
      <li>Lorem</li>
      <li>ipsum</li>
      <li>dolor</li>
      <li>sit</li>
      <li>amet</li>
      <li>consectetur</li>
      <li>Lorem</li>
      <li>ipsum</li>
      <li>dolor</li>
      <li>sit</li>
      <li>amet</li>
      <li>consectetur</li>
    </ul>
  </section>
</div>


<footer></footer>
<script src="/socket.io/socket.io.js"></script>
<script>
  const messageValue = document.getElementById('messageValue')
  const messageType = document.getElementById('messageType')
  const btnSendMessage = document.getElementById('btnSendMessage');
  const winnerList = document.getElementById('winnerList');
  const wordList = document.getElementById('wordList');
  const inputWord = document.getElementById('setWord-setWord');
  // const wordHistory = document.getElementById('wordHistory');
  const params = new URLSearchParams(location.search);

  const KEYS = {
    currentWord: 'yourdle.currentWord',
    wordHistory: 'yourdle.wordHistory',
    winners: 'yourdle.winners'
  }

  const db = (() => {
    let watchList = {};
    let winners = Array(10);
    const db = {
      addWord: (word) => {
        // db.wordHistory.add(db.currentWord.get());
        db.currentWord.set(word);
      },
      getWord: () => db.currentWord.get(),
      hasWord: () => !!db.getWord(),
      getHistory: () => db.wordHistory.get(),
      currentWord: {
        get: () => localStorage.getItem(KEYS.currentWord),
        set: (word) => localStorage.setItem(KEYS.currentWord, word),
      },
      getWinners: () => {
        if(!localStorage.getItem(KEYS.winners)) {
          localStorage.setItem(KEYS.winners, JSON.stringify(winners));
        } else {
          winners = JSON.parse(localStorage.getItem(KEYS.winners));
        }

        return winners;
      },
      addWinner: (name, word) => {
        winners.push({name, word});

        if(winners.length>10) {
          winners.shift();
        }

        localStorage.setItem(KEYS.winners, JSON.stringify(winners))
      },
      wordHistory: (() => {
        let wordList = [];

        if (!localStorage.getItem(KEYS.wordHistory)) {
          localStorage.setItem(KEYS.wordHistory, JSON.stringify(wordList));
        } else {
          wordList = JSON.parse(localStorage.getItem(KEYS.wordHistory));
        }

        return {
          get: () => {
            return wordList;
          },
          save: () => {
            localStorage.setItem(KEYS.wordHistory, JSON.stringify(wordList))
          },
          add: (word) => {
            wordList.push(word);
            db.wordHistory.save();
          },
        }
      })(),
      watch: (() => {
        return (event, cb) => {
          if (!watchList[event]) {
            watchList[event] = new Set();
          }

          watchList[event].add(cb);
        };
      })()
    }

    return db;
  })();

  // enable debug
  if (location.search.toLowerCase().includes('debug=true')) {
    document.getElementById('debugArea').setAttribute('style', 'display: block')
  }

  var socket = io();

  socket.on('reload', function () {
    console.log('reloading admin');
    document.getElementById('__refresh').setAttribute('href', document.location);
    document.getElementById('__refresh').click();
  });

  socket.on('connect', () => {
    socket.emit('join', params.get('name'))
  });

  socket.on('winner', ({user, word}) => {
    db.addWinner(user, word);
    updateWinnerList();
  });

  function updateWinnerList() {
    let winners = db.getWinners();
    winnerList.innerHTML = '';
    winners.forEach(({name, word}) => {
      let li = document.createElement('li');
      li.innerText = `${name} (${word})`
      winnerList.appendChild(li);
    })
  }

  btnSendMessage.addEventListener('click', () => {
    console.log(`emitting message ${messageType.value} and ${messageValue.value}`);
    socket.to(params.get('name')).emit(messageType.value, messageValue.value);
  })

  // If we have a word set, populate the word input
  if (db.hasWord()) {
    inputWord.value = db.getWord();
  }

  // Easy Form Message
  const formMessage = document.getElementsByClassName('formMessage')
  Array.from(formMessage).forEach(e => {
    e.addEventListener('submit', event => {
      let message = { type: null, value: null };

      Array.from(event.target.elements).forEach(el => {
        if (el.name === 'message' && el.value.trim().length > 0) {
          message.value = el.value.trim();
          message.type = event.target.action.substring(event.target.action.lastIndexOf('/') + 1);
        }
      });

      switch (message.type) {
        case 'setWord':
          db.addWord(message.value);
          break;
      }

      console.log(`type: ${message.type}; value: ${message.value}`)
      socket.emit(message.type, message.value);
      event.preventDefault();
    })
  });

  // function addWord(word) {
  //   let li = document.createElement('li')
  //   li.innerText = `${word}`;
  //
  //   let remove = document.createElement('button')
  //   remove.classList.add('deleteHistory')
  //   remove.innerText = 'âŒ«'
  //
  //   li.appendChild(remove);
  //   return li;
  // }
  //
  // //// Word History
  // db.getHistory().forEach(word => {
  //   wordHistory.appendChild(addWord(word));
  // })


</script>
</body>
</html>
